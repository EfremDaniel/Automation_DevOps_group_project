name: Deploy Docker image to Azure Web App

on:
  workflow_run:
    workflows:
      - "Build docker image"
    types:
      - completed
  workflow_dispatch: {}   # beh√•ll manuell trigger

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/myapp:latest
  AZURE_WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Azure Web App (container)
    runs-on: ubuntu-latest

    if: ${{ 
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'
    }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Azure Web App to use Docker image and restart
        uses: azure/cli@v1
        with:
          inlineScript: |
            az webapp config container set \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --docker-custom-image-name ${{ env.DOCKER_IMAGE }} \
              --docker-registry-server-url https://index.docker.io \
              --docker-registry-server-user ${{ secrets.DOCKERHUB_USERNAME }} \
              --docker-registry-server-password ${{ secrets.DOCKERHUB_TOKEN }}
            az webapp restart --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

      - name: Deployment complete
        run: echo "Deployment finished successfully."


