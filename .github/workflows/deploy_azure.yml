name: Deploy Docker image to Azure Web App

on:
  workflow_run:
    workflows:
      - "Build docker image"
    types:
      - completed

  # Fallback trigger from Build-workflow
  repository_dispatch:
    types: [run-deploy]

  # Keep manual trigger
  workflow_dispatch:

env:
  DOCKER_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/myapp:latest
  AZURE_WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to Azure Web App (container)
    runs-on: ubuntu-latest

    if: ${{ 
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') 
      || github.event_name == 'workflow_dispatch'
      || github.event_name == 'repository_dispatch'
    }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug secrets used
        run: |
          echo "WEBAPP_NAME=${{ env.AZURE_WEBAPP_NAME }}"
          echo "RESOURCE_GROUP=${{ env.AZURE_RESOURCE_GROUP }}"

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Debug Azure account inside Actions
        run: |
          az account show --output json

      - name: Configure Azure Web App to use Docker image and restart
        uses: azure/cli@v1
        with:
          inlineScript: |
            az webapp config container set \
              --name ${{ env.AZURE_WEBAPP_NAME }} \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --docker-custom-image-name ${{ env.DOCKER_IMAGE }} \
              --docker-registry-server-url https://index.docker.io \
              --docker-registry-server-user ${{ secrets.DOCKERHUB_USERNAME }} \
              --docker-registry-server-password ${{ secrets.DOCKERHUB_TOKEN }}
            az webapp restart --name ${{ env.AZURE_WEBAPP_NAME }} --resource-group ${{ env.AZURE_RESOURCE_GROUP }}

      - name: Deployment complete
        run: echo "Deployment finished successfully."

